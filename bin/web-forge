#!/usr/bin/env node

const createTempExtension = require('./handleExtensionFolder.js');
const createServer = require('./server.js');
const pathLib = require('path');
const { exec } = require('child_process');

class Webforge {
    async run(browser, path, args) {
        const filterValues = ValidateValues(browser, path);
        if (filterValues.result) {
            try {
                const tempDirPath = await createTempExtension(path);
                createServer(filterValues.path);
                filterValues.launchArgs = filterValues.launchArgs + ` --user-data-dir=${pathLib.join(tempDirPath, 'userFolder')} --load-extension=${tempDirPath} ${args}`;

                exec(filterValues.launchArgs, (error, stdout, stderr) => {
                    if (error) {
                        console.error(`Error: ${error.message}`);
                        return;
                    }
                    if (stderr) {
                        console.error(`stderr: ${stderr}`);
                        return;
                    }
                    console.log(`stdout: ${stdout}`);
                });
            } catch (error) {
                console.log(error);
            }

        } else {
            console.error(filterValues.error);
        }
    }
}


function ValidateValues(browser, path) {
    const filterValues = {
        result: true,
        error: 'Default',
        launchArgs: ''
    };

    // Checks browser
    switch (browser) {
        case 'firefox':
        case 'ff':

            break;
        case 'chrome':
        case 'ch':
            if (path != "" && path) {
                filterValues.path = path;
            } else {
                filterValues.path = process.cwd();
            }
            filterValues.launchArgs = `start chrome`;
            break;
        case 'edge':
        case 'msedge':

            break;
        case 'brave':
        case 'br':

            break;
        default:
            filterValues.result = false;
            filterValues.error = `Browser was unknown. Either it was wrong syntax or unknown browser. ${browser}`;
            return filterValues;
    }

    return filterValues;
}

function validateBrowser(browser) {
    const browserMappings = [
        ['firefox', 'ff',],
        ['chrome', 'ch'],
        ['edge', 'msedge'],
        ['brave', 'br']
    ];

    for (const mapping of browserMappings) {
        if (mapping.includes(browser)) {
            return mapping[0];
        }
    }

    return false;
}


const [, , method, browser , path, ...optionalArgs] = process.argv;

if (method !== undefined) {
    switch (method) {
        case "-b":
            // In the workings
            break;

        case "-r":
            if (validateBrowser(browser) !== false) {
                const webforge = new Webforge();
                webforge.run(browser, path, optionalArgs);
            } else {
                console.error(`Unknown browser: ${browser}`);
            }
            break;

        default:
            console.error(`Unknown method: ${method}`);
            break;
    }
} else {
    console.log('Usage: web-forge <-b|-r> <path> <optional arguments>');
}